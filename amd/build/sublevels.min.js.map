{"version":3,"file":"sublevels.min.js","sources":["../src/sublevels.js"],"sourcesContent":["import ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Fragment from 'core/fragment';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport Template from 'core/templates';\n\n// The function called from the Mustache template to render the ADD_LEVEL modal\nexport const init_add = (contextid) => {\n    // Set up a SAVE_CANCEL modal.\n    ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: 'Add Sublevel',\n        body: get_form(null, contextid),\n    })\n        // Set up the listeners\n        .then((modal) => {\n            document.addEventListener('click', (event) => {\n                if (\n                    event.target &&\n                    event.target.classList.contains('add_sublevel')\n                ) {\n                    showModal(event, modal);\n                }\n            });\n\n            const root = modal.getRoot();\n            const form = root.find('form');\n\n            root.on(ModalEvents.save, (event) => submitForm(event, form));\n            form.on('submit', (event) =>\n                submitAddFormAjax(event, modal, form, contextid)\n            );\n        })\n        // Close modal\n        .then((modal) => {\n            modal.close();\n        });\n};\n\nconst showModal = (event, modal) => {\n    event.preventDefault();\n    let root = modal.getRoot();\n    modal.show();\n    // Adds chapter ID to invoked modal form so we can save to DB\n    root.find('form')\n        .find('input[name=\"chapterid\"]')\n        .val(event.target.parentNode.dataset.cid);\n\n    // Adds parentlevel ID to invoked modal form so we can save to DB\n    root.find('form')\n        .find('input[name=\"parentlevelid\"]')\n        .val(event.target.parentNode.dataset.plid);\n};\n\nconst get_form = (formdata, contextid) => {\n    if (typeof formdata === 'undefined') {\n        formdata = {};\n    }\n    var params = { jsonformdata: JSON.stringify(formdata) };\n    return Fragment.loadFragment(\n        'block_mission_map',\n        'sublevel_form',\n        contextid,\n        params\n    );\n};\n\nconst submitForm = (event, form) => {\n    event.preventDefault();\n    form.submit();\n};\n\nconst submitAddFormAjax = (event, modal, form, contextid) => {\n    event.preventDefault();\n\n    let formData = form.serialize();\n    Ajax.call([\n        {\n            methodname: 'block_mission_map_create_sublevel',\n            args: {\n                contextid: contextid,\n                jsonformdata: JSON.stringify(formData),\n            },\n            done: (data) => handleAddFormSubmissionResponse(data, modal),\n            fail: (data) => handleFormSubmissionFailure(data, modal),\n        },\n    ]);\n};\n\nconst handleFormSubmissionFailure = (data, modal) => {\n    modal.hide();\n    Notification.alert('Warning', JSON.parse(data), 'Continue');\n};\n\nconst handleAddFormSubmissionResponse = (data, modal) => {\n    let level = JSON.parse(data.data);\n    let context = {\n        id: level.id,\n        chapterid: level.chapterid,\n        name: level.name,\n        url: level.url,\n    };\n\n    const chapter = document.querySelector(`[data-cid=\"${level.chapterid}\"]`);\n\n    Template.render('block_mission_map/dot', context)\n        .then((html, js) => {\n            Template.appendNodeContents(chapter, html, js);\n            modal.hide();\n        })\n        .fail((ex) => {\n            Notification.alert('Warning', ex, 'Continue');\n        });\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_modal_factory","_modal_events","_fragment","_ajax","_notification","_templates","_exports","init_add","contextid","ModalFactory","create","type","types","SAVE_CANCEL","title","body","get_form","then","modal","document","addEventListener","event","target","classList","contains","showModal","root","getRoot","form","find","on","ModalEvents","save","submitForm","submitAddFormAjax","close","preventDefault","show","val","parentNode","dataset","cid","plid","formdata","params","jsonformdata","JSON","stringify","Fragment","loadFragment","submit","formData","serialize","Ajax","call","methodname","args","done","data","handleAddFormSubmissionResponse","fail","handleFormSubmissionFailure","hide","Notification","alert","parse","level","context","id","chapterid","name","url","chapter","querySelector","concat","Template","render","html","js","appendNodeContents","ex"],"mappings":"qPAKsC,SAAAA,uBAAAC,KAAAA,OAAAA,KAAAA,IAAAC,WAAAD,IAAAE,CAAAA,QAAAF,IAAA,kFALtCG,eAAAJ,uBAAAI,gBACAC,cAAAL,uBAAAK,eACAC,UAAAN,uBAAAM,WACAC,MAAAP,uBAAAO,OACAC,cAAAR,uBAAAQ,eACAC,WAAAT,uBAAAS,YAiCEC,SAAAC,SA9BsB,SAACC,WAErBC,eAAYV,QAACW,OAAO,CAChBC,KAAMF,eAAAA,QAAaG,MAAMC,YACzBC,MAAO,eACPC,KAAMC,SAAS,KAAMR,aAGpBS,MAAK,SAACC,OACHC,SAASC,iBAAiB,SAAS,SAACC,OAE5BA,MAAMC,QACND,MAAMC,OAAOC,UAAUC,SAAS,iBAEhCC,UAAUJ,MAAOH,MAEzB,IAEA,IAAMQ,KAAOR,MAAMS,UACbC,KAAOF,KAAKG,KAAK,QAEvBH,KAAKI,GAAGC,cAAAA,QAAYC,MAAM,SAACX,OAAK,OAAKY,WAAWZ,MAAOO,SACvDA,KAAKE,GAAG,UAAU,SAACT,OAAK,OACpBa,kBAAkBb,MAAOH,MAAOU,KAAMpB,UAAU,GAExD,IAECS,MAAK,SAACC,OACHA,MAAMiB,OACV,KAGR,IAAMV,UAAY,SAACJ,MAAOH,OACtBG,MAAMe,iBACN,IAAIV,KAAOR,MAAMS,UACjBT,MAAMmB,OAENX,KAAKG,KAAK,QACLA,KAAK,2BACLS,IAAIjB,MAAMC,OAAOiB,WAAWC,QAAQC,KAGzCf,KAAKG,KAAK,QACLA,KAAK,+BACLS,IAAIjB,MAAMC,OAAOiB,WAAWC,QAAQE,OAGvC1B,SAAW,SAAC2B,SAAUnC,gBACA,IAAbmC,WACPA,SAAW,CAAA,GAEf,IAAIC,OAAS,CAAEC,aAAcC,KAAKC,UAAUJ,WAC5C,OAAOK,UAAAA,QAASC,aACZ,oBACA,gBACAzC,UACAoC,SAIFX,WAAa,SAACZ,MAAOO,MACvBP,MAAMe,iBACNR,KAAKsB,UAGHhB,kBAAoB,SAACb,MAAOH,MAAOU,KAAMpB,WAC3Ca,MAAMe,iBAEN,IAAIe,SAAWvB,KAAKwB,YACpBC,MAAItD,QAACuD,KAAK,CACN,CACIC,WAAY,oCACZC,KAAM,CACFhD,UAAWA,UACXqC,aAAcC,KAAKC,UAAUI,WAEjCM,KAAM,SAACC,MAAI,OAAKC,gCAAgCD,KAAMxC,MAAM,EAC5D0C,KAAM,SAACF,MAAI,OAAKG,4BAA4BH,KAAMxC,MAAM,MAK9D2C,4BAA8B,SAACH,KAAMxC,OACvCA,MAAM4C,OACNC,cAAAA,QAAaC,MAAM,UAAWlB,KAAKmB,MAAMP,MAAO,aAG9CC,gCAAkC,SAACD,KAAMxC,OAC3C,IAAIgD,MAAQpB,KAAKmB,MAAMP,KAAKA,MACxBS,QAAU,CACVC,GAAIF,MAAME,GACVC,UAAWH,MAAMG,UACjBC,KAAMJ,MAAMI,KACZC,IAAKL,MAAMK,KAGTC,QAAUrD,SAASsD,cAAa,cAAAC,OAAeR,MAAMG,UAAS,OAEpEM,WAAAA,QAASC,OAAO,wBAAyBT,SACpClD,MAAK,SAAC4D,KAAMC,IACTH,WAAQ5E,QAACgF,mBAAmBP,QAASK,KAAMC,IAC3C5D,MAAM4C,MACV,IACCF,MAAK,SAACoB,IACHjB,cAAYhE,QAACiE,MAAM,UAAWgB,GAAI,WACtC,IACN"}