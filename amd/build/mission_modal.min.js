define("block_mission_map/mission_modal",["jquery","core/ajax","core/notification","core/modal_factory","core/modal_events","core/templates","core/str"],(function($,ajax,notification,ModalFactory,ModalEvents,Templates,str){return{init:function(blockid,courseid){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:"Add Mission",body:Templates.render("block_mission_map/add_mission_modal",{blockid:blockid,courseid:courseid})}).then((function(modal){function loadCourseActivities(selectedCmid){ajax.call([{methodname:"block_mission_map_get_course_activities",args:{courseid:courseid}}])[0].then((function(response){response.success&&response.activities&&function(activities,selectedCmid){var dropdown=modal.getRoot().find("#missionActivitySelect");dropdown.empty(),str.get_string("select_activity","block_mission_map").then((function(selectActivityText){dropdown.append('<option value="">'+selectActivityText+"</option>"),activities.forEach((function(section){section.activities.length>0&&(dropdown.append('<optgroup label="'+section.section_name+'">'),section.activities.forEach((function(activity){var option=$("<option></option>").attr("value",activity.id).data("url",activity.url).text(activity.name+" ("+activity.type+")");selectedCmid&&String(selectedCmid)==String(activity.id)&&(option.attr("selected","selected"),modal.getRoot().find("#selectedActivityUrl").val(activity.url)),dropdown.append(option)})),dropdown.append("</optgroup>"))}))}))}(response.activities,selectedCmid)})).catch((function(error){notification.addNotification({message:"Error loading activities: "+error.message,type:"error"})}))}function loadCourseSections(selectedSectionid){ajax.call([{methodname:"block_mission_map_get_course_sections",args:{courseid:courseid}}])[0].then((function(response){response.success&&response.sections?function(sections,selectedSectionid){var dropdown=modal.getRoot().find("#missionSectionSelect");dropdown.empty(),str.get_string("select_section","block_mission_map").then((function(selectSectionText){dropdown.append('<option value="">'+selectSectionText+"</option>"),sections.forEach((function(section){var option=$("<option></option>").attr("value",section.id).data("url",section.url).text(section.name);selectedSectionid&&String(selectedSectionid)==String(section.id)&&(option.attr("selected","selected"),modal.getRoot().find("#selectedSectionUrl").val(section.url)),dropdown.append(option)}))}))}(response.sections,selectedSectionid):notification.addNotification({message:"Invalid response from server",type:"error"})})).catch((function(error){notification.addNotification({message:"Error loading sections: "+(error.message||"Unknown error"),type:"error"})}))}function filterActivities(searchTerm){var dropdown=modal.getRoot().find("#missionActivitySelect");dropdown.find("option").each((function(){var option=$(this),text=option.text().toLowerCase();""===option.val()||""===searchTerm||text.includes(searchTerm)?option.show():option.hide()})),dropdown.find("optgroup").each((function(){var optgroup=$(this);0===optgroup.find("option:visible").not('[value=""]').length?optgroup.hide():optgroup.show()}))}modal.getRoot().on("change","#missionType",(function(){var type=$(this).val();"1"==type?($("#urlGroup").show(),$("#activityGroup").hide(),$("#sectionGroup").hide()):"2"==type?($("#urlGroup").hide(),$("#activityGroup").show(),$("#sectionGroup").hide(),loadCourseActivities()):"3"==type?($("#urlGroup").hide(),$("#activityGroup").hide(),$("#sectionGroup").show(),loadCourseSections()):($("#urlGroup").hide(),$("#activityGroup").hide(),$("#sectionGroup").hide())})),modal.getRoot().on("input","#missionActivitySearch",(function(){filterActivities($(this).val().toLowerCase())})),modal.getRoot().on("click","#clearSearchBtn",(function(){$("#missionActivitySearch").val(""),filterActivities("")})),modal.getRoot().on("change","#missionActivitySelect",(function(){var selectedOption=$(this).find("option:selected"),cmid=selectedOption.val(),url=selectedOption.data("url");cmid?$("#selectedActivityUrl").val(url):$("#selectedActivityUrl").val("")})),modal.getRoot().on("change","#missionSectionSelect",(function(){var selectedOption=$(this).find("option:selected"),sectionId=selectedOption.val(),url=selectedOption.data("url");sectionId?$("#selectedSectionUrl").val(url):$("#selectedSectionUrl").val("")})),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault();var missionName=modal.getRoot().find("#missionName").val().trim(),missionType=modal.getRoot().find("#missionType").val(),missionUrl=modal.getRoot().find("#missionUrl").val(),selectedActivityId=modal.getRoot().find("#missionActivitySelect").val(),selectedSectionId=modal.getRoot().find("#missionSectionSelect").val(),missionColor=modal.getRoot().find("#missionColor").val(),missionDescription=modal.getRoot().find("#missionDescription").val();if(missionName)if("1"!=missionType||missionUrl)if("2"!=missionType||selectedActivityId)if("3"!=missionType||selectedSectionId){var editingChapterId=modal.getRoot().data("editing-chapter-id"),editingMissionId=modal.getRoot().data("editing-mission-id"),data={blockid:blockid,courseid:courseid,chapterid:editingChapterId,name:missionName,description:missionDescription,type:parseInt(missionType),color:missionColor,url:"1"==missionType?missionUrl:"2"==missionType?modal.getRoot().find("#selectedActivityUrl").val():"3"==missionType?modal.getRoot().find("#selectedSectionUrl").val():null,cmid:"2"==missionType?selectedActivityId:null,sectionid:"3"==missionType?selectedSectionId:null};editingMissionId&&(data.levelid=editingMissionId),modal.getRoot().find('[data-action="save"]').prop("disabled",!0).text("Saving..."),ajax.call([{methodname:"block_mission_map_create_level",args:data}])[0].then((function(response){if(response.success)notification.addNotification({message:editingMissionId?"Mission updated successfully!":"Mission created successfully!",type:"success"}),modal.hide(),setTimeout((function(){window.location.reload()}),1e3);else{var errorMsg=editingMissionId?"Error updating mission":"Error creating mission";notification.addNotification({message:response.message||errorMsg,type:"error"})}})).catch((function(error){notification.addNotification({message:"Error saving mission: "+error.message,type:"error"})})).always((function(){modal.getRoot().find('[data-action="save"]').prop("disabled",!1).text("Save")}))}else notification.addNotification({message:"Please select a course section",type:"error"});else notification.addNotification({message:"Please select a course activity",type:"error"});else notification.addNotification({message:"Mission URL is required for URL type missions",type:"error"});else notification.addNotification({message:"Mission name is required",type:"error"})})),modal.getRoot().on(ModalEvents.hidden,(function(){var form=modal.getRoot().find("#addMissionForm")[0];form&&form.reset(),modal.getRoot().find("#urlGroup").show(),modal.getRoot().find("#activityGroup").hide(),modal.getRoot().find("#sectionGroup").hide(),modal.getRoot().find("#missionActivitySearch").val(""),modal.getRoot().find("#missionActivitySelect").val(""),modal.getRoot().find("#missionSectionSelect").val("")})),$(document).on("click",".add-mission-btn",(function(e){e.preventDefault();var chapterId=$(this).data("chapter-id"),chapterName=$(this).data("chapter-name");modal.getRoot().data("editing-chapter-id",chapterId),modal.getRoot().data("editing-mission-id",null),modal.getRoot().find(".modal-title").text("Add Mission to: "+chapterName);var form=modal.getRoot().find("#addMissionForm")[0];form&&form.reset(),modal.getRoot().find("#urlGroup").show(),modal.getRoot().find("#activityGroup").hide(),modal.getRoot().find("#sectionGroup").hide(),modal.show()})),$(document).on("click",".mission",(function(e){e.preventDefault(),$(".mission-actions").hide(),$(this).siblings(".mission-actions").show()})),$(document).on("click",".mission-view-btn",(function(e){e.preventDefault();var url=$(this).data("url");window.location.href=url})),$(document).on("click",".mission-delete-btn",(function(e){e.preventDefault(),e.stopPropagation();var missionId=$(this).data("mission-id"),missionName=$(this).data("mission-name"),courseId=$(this).data("course-id");if(confirm('Are you sure you want to delete the mission "'+missionName+'"? This action cannot be undone.')){var request={methodname:"block_mission_map_delete_level",args:{levelid:missionId,courseid:courseId}};ajax.call([request])[0].then((function(response){response.success?(notification.addNotification({message:response.message||"Mission deleted successfully",type:"success"}),window.location.reload()):notification.addNotification({message:response.message||"Failed to delete mission",type:"error"})})).catch((function(){notification.addNotification({message:"An error occurred while deleting the mission",type:"error"})}))}})),$(document).on("click",".mission-edit-btn",(function(e){e.preventDefault();var missionId=$(this).data("mission-id"),missionName=$(this).data("mission-name"),missionDescription=$(this).data("mission-description"),missionType=$(this).data("mission-type"),missionUrl=$(this).data("mission-url"),missionColor=$(this).data("mission-color"),chapterId=$(this).data("chapter-id"),missionCmid=$(this).data("mission-cmid"),missionSectionid=$(this).data("mission-sectionid");modal.getRoot().data("editing-mission-id",missionId),modal.getRoot().data("editing-chapter-id",chapterId),modal.getRoot().find(".modal-title").text("Edit Mission: "+missionName),modal.getRoot().find("#missionName").val(missionName),modal.getRoot().find("#missionDescription").val(missionDescription),modal.getRoot().find("#missionColor").val(missionColor),modal.getRoot().find("#missionType").val(missionType),"1"==missionType?(modal.getRoot().find("#urlGroup").show(),modal.getRoot().find("#activityGroup").hide(),modal.getRoot().find("#sectionGroup").hide(),modal.getRoot().find("#missionUrl").val(missionUrl)):"2"==missionType?(modal.getRoot().find("#urlGroup").hide(),modal.getRoot().find("#activityGroup").show(),modal.getRoot().find("#sectionGroup").hide(),loadCourseActivities(missionCmid),modal.getRoot().find("#selectedActivityUrl").val(missionUrl)):"3"==missionType?(modal.getRoot().find("#urlGroup").hide(),modal.getRoot().find("#activityGroup").hide(),modal.getRoot().find("#sectionGroup").show(),loadCourseSections(missionSectionid),modal.getRoot().find("#selectedSectionUrl").val(missionUrl)):(modal.getRoot().find("#urlGroup").hide(),modal.getRoot().find("#activityGroup").hide(),modal.getRoot().find("#sectionGroup").hide()),modal.show()})),$(document).on("click",(function(e){$(e.target).closest(".mission-container").length||$(".mission-actions").hide()}))})).catch((function(error){notification.addNotification({message:"Error creating mission modal: "+error.message,type:"error"})}))}}}));

//# sourceMappingURL=mission_modal.min.js.map