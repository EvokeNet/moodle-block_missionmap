{"version":3,"file":"chapter_modal.min.js","sources":["../src/chapter_modal.js"],"sourcesContent":["define(['jquery', 'core/ajax', 'core/notification', 'core/modal_factory', 'core/modal_events', 'core/templates'],\n    function($, ajax, notification, ModalFactory, ModalEvents, Templates) {\n\n    return {\n        init: function(blockid, courseid) {\n\n            // Create modal using Moodle's ModalFactory with template\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: 'Add Chapter',\n                body: Templates.render('block_mission_map/add_chapter_modal', {\n                    blockid: blockid,\n                    courseid: courseid\n                })\n            }).then(function(modal) {\n\n                // Show/hide unlock date field based on checkbox\n                modal.getRoot().on('change', '#hasLock', function() {\n                    if ($(this).is(':checked')) {\n                        $('#unlockDateGroup').show();\n                    } else {\n                        $('#unlockDateGroup').hide();\n                    }\n                });\n\n                // Handle save event using Moodle's standard save event\n                modal.getRoot().on(ModalEvents.save, function(e) {\n                    e.preventDefault();\n\n                    var chapterName = $('#chapterName').val().trim();\n\n                    if (!chapterName) {\n                        notification.addNotification({\n                            message: 'Chapter name is required',\n                            type: 'error'\n                        });\n                        return;\n                    }\n\n                    var hasLock = $('#hasLock').is(':checked');\n                    var unlockingDate = hasLock ? $('#unlockDate').val() : null;\n                    var editingChapterId = modal.getRoot().data('editing-chapter-id');\n\n                    // Prepare data\n                    var data = {\n                        blockid: blockid,\n                        courseid: courseid,\n                        name: chapterName,\n                        has_lock: hasLock ? 1 : 0,\n                        unlocking_date: unlockingDate\n                    };\n\n                    // Add chapter ID if editing\n                    if (editingChapterId) {\n                        data.chapterid = editingChapterId;\n                    }\n\n                    // Show loading state\n                    modal.getRoot().find('[data-action=\"save\"]').prop('disabled', true).text('Saving...');\n\n                    // Make AJAX call to create or update chapter\n                    ajax.call([{\n                        methodname: 'block_mission_map_create_chapter',\n                        args: data\n                    }])[0].then(function(response) {\n                        if (response.success) {\n                            notification.addNotification({\n                                message: editingChapterId ? 'Chapter updated successfully!' : 'Chapter created successfully!',\n                                type: 'success'\n                            });\n\n                            // Close modal and reload page\n                            modal.hide();\n                            setTimeout(function() {\n                                window.location.reload();\n                            }, 1000);\n                        } else {\n                            notification.addNotification({\n                                message: response.message || 'Error saving chapter',\n                                type: 'error'\n                            });\n                        }\n                    }).catch(function(error) {\n                        notification.addNotification({\n                            message: 'Error saving chapter: ' + error.message,\n                            type: 'error'\n                        });\n                    }).always(function() {\n                        // Reset button state\n                        modal.getRoot().find('[data-action=\"save\"]').prop('disabled', false).text('Save');\n                    });\n                });\n\n                // Reset form when modal is closed\n                modal.getRoot().on(ModalEvents.hidden, function() {\n                    $('#addChapterForm')[0].reset();\n                    $('#unlockDateGroup').hide();\n                });\n\n                // Show modal when button is clicked (both main button and header button)\n                $('button[data-target=\"#addChapterModal\"], .editing_add_chapter').on('click', function(e) {\n                    e.preventDefault();\n                    modal.show();\n                });\n\n                // Handle edit chapter buttons\n                $(document).on('click', '.edit-chapter-btn', function(e) {\n                    e.preventDefault();\n                    var chapterId = $(this).data('chapter-id');\n                    var chapterName = $(this).data('chapter-name');\n                    var hasLock = $(this).data('has-lock');\n                    var unlockDate = $(this).data('unlock-date');\n\n                    // Debug: log the data being received\n                    console.log('Edit chapter clicked:', {\n                        chapterId: chapterId,\n                        chapterName: chapterName,\n                        hasLock: hasLock,\n                        unlockDate: unlockDate\n                    });\n\n                    // Populate modal with existing data\n                    $('#chapterName').val(chapterName);\n                    $('#hasLock').prop('checked', hasLock == 1);\n                    if (hasLock == 1) {\n                        $('#unlockDateGroup').show();\n                        if (unlockDate) {\n                            $('#unlockDate').val(unlockDate);\n                        }\n                    } else {\n                        $('#unlockDateGroup').hide();\n                    }\n\n                    // Store chapter ID for update\n                    modal.getRoot().data('editing-chapter-id', chapterId);\n\n                    modal.show();\n                });\n\n            }).catch(function(error) {\n                notification.addNotification({\n                    message: 'Error creating modal: ' + error.message,\n                    type: 'error'\n                });\n            });\n        }\n    };\n});"],"names":["define","$","ajax","notification","ModalFactory","ModalEvents","Templates","init","blockid","courseid","create","type","types","SAVE_CANCEL","title","body","render","then","modal","getRoot","on","this","is","show","hide","save","e","preventDefault","chapterName","val","trim","hasLock","unlockingDate","editingChapterId","data","name","has_lock","unlocking_date","chapterid","find","prop","text","call","methodname","args","response","success","addNotification","message","setTimeout","window","location","reload","catch","error","always","hidden","reset","document","chapterId","unlockDate","console","log"],"mappings":"AAAAA,yCAAO,CAAC,SAAU,YAAa,oBAAqB,qBAAsB,oBAAqB,mBAC3F,SAASC,EAAGC,KAAMC,aAAcC,aAAcC,YAAaC,iBAEpD,CACHC,KAAM,SAASC,QAASC,UAGpBL,aAAaM,OAAO,CAChBC,KAAMP,aAAaQ,MAAMC,YACzBC,MAAO,cACPC,KAAMT,UAAUU,OAAO,sCAAuC,CAC1DR,QAASA,QACTC,SAAUA,aAEfQ,MAAK,SAASC,OAGbA,MAAMC,UAAUC,GAAG,SAAU,YAAY,WACjCnB,EAAEoB,MAAMC,GAAG,YACXrB,EAAE,oBAAoBsB,OAEtBtB,EAAE,oBAAoBuB,UAK9BN,MAAMC,UAAUC,GAAGf,YAAYoB,MAAM,SAASC,GAC1CA,EAAEC,qBAEEC,YAAc3B,EAAE,gBAAgB4B,MAAMC,UAErCF,iBAQDG,QAAU9B,EAAE,YAAYqB,GAAG,YAC3BU,cAAgBD,QAAU9B,EAAE,eAAe4B,MAAQ,KACnDI,iBAAmBf,MAAMC,UAAUe,KAAK,sBAGxCA,KAAO,CACP1B,QAASA,QACTC,SAAUA,SACV0B,KAAMP,YACNQ,SAAUL,QAAU,EAAI,EACxBM,eAAgBL,eAIhBC,mBACAC,KAAKI,UAAYL,kBAIrBf,MAAMC,UAAUoB,KAAK,wBAAwBC,KAAK,YAAY,GAAMC,KAAK,aAGzEvC,KAAKwC,KAAK,CAAC,CACPC,WAAY,mCACZC,KAAMV,QACN,GAAGjB,MAAK,SAAS4B,UACbA,SAASC,SACT3C,aAAa4C,gBAAgB,CACzBC,QAASf,iBAAmB,gCAAkC,gCAC9DtB,KAAM,YAIVO,MAAMM,OACNyB,YAAW,WACPC,OAAOC,SAASC,WACjB,MAEHjD,aAAa4C,gBAAgB,CACzBC,QAASH,SAASG,SAAW,uBAC7BrC,KAAM,aAGf0C,OAAM,SAASC,OACdnD,aAAa4C,gBAAgB,CACzBC,QAAS,yBAA2BM,MAAMN,QAC1CrC,KAAM,aAEX4C,QAAO,WAENrC,MAAMC,UAAUoB,KAAK,wBAAwBC,KAAK,YAAY,GAAOC,KAAK,gBAzD1EtC,aAAa4C,gBAAgB,CACzBC,QAAS,2BACTrC,KAAM,aA4DlBO,MAAMC,UAAUC,GAAGf,YAAYmD,QAAQ,WACnCvD,EAAE,mBAAmB,GAAGwD,QACxBxD,EAAE,oBAAoBuB,UAI1BvB,EAAE,gEAAgEmB,GAAG,SAAS,SAASM,GACnFA,EAAEC,iBACFT,MAAMK,UAIVtB,EAAEyD,UAAUtC,GAAG,QAAS,qBAAqB,SAASM,GAClDA,EAAEC,qBACEgC,UAAY1D,EAAEoB,MAAMa,KAAK,cACzBN,YAAc3B,EAAEoB,MAAMa,KAAK,gBAC3BH,QAAU9B,EAAEoB,MAAMa,KAAK,YACvB0B,WAAa3D,EAAEoB,MAAMa,KAAK,eAG9B2B,QAAQC,IAAI,wBAAyB,CACjCH,UAAWA,UACX/B,YAAaA,YACbG,QAASA,QACT6B,WAAYA,aAIhB3D,EAAE,gBAAgB4B,IAAID,aACtB3B,EAAE,YAAYuC,KAAK,UAAsB,GAAXT,SACf,GAAXA,SACA9B,EAAE,oBAAoBsB,OAClBqC,YACA3D,EAAE,eAAe4B,IAAI+B,aAGzB3D,EAAE,oBAAoBuB,OAI1BN,MAAMC,UAAUe,KAAK,qBAAsByB,WAE3CzC,MAAMK,aAGX8B,OAAM,SAASC,OACdnD,aAAa4C,gBAAgB,CACzBC,QAAS,yBAA2BM,MAAMN,QAC1CrC,KAAM"}