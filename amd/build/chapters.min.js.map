{"version":3,"sources":["../src/chapters.js"],"names":["init","params","contextid","blockid","courseid","document","addEventListener","event","target","classList","contains","create_modal","formdata","chapterid","dataset","cid","name","cname","has_lock","haslock","unlocking_date","unlock","ModalFactory","create","type","types","SAVE_CANCEL","title","body","get_form","then","modal","root","getRoot","form","find","on","ModalEvents","save","submitForm","submitFormAjax","show","close","jsonformdata","JSON","stringify","Fragment","loadFragment","preventDefault","submit","changeEvent","createEvent","initEvent","each","element","dispatchEvent","formData","serialize","Ajax","call","methodname","args","done","data","handleFormSubmissionResponse","fail","handleFormSubmissionFailure","Notification","alert","parse","map","getElementById","chapter","updated","location","reload","context","id","Template","render","html","js","appendNodeContents","hide","ex"],"mappings":"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","sourcesContent":["import ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Fragment from 'core/fragment';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport Template from 'core/templates';\n\n// The function called from the Mustache template.\nexport const init = (params) => {\n    const { contextid, blockid, courseid } = params;\n\n    document.addEventListener('click', (event) => {\n        if (event.target && event.target.classList.contains('edit_chapter')) {\n            create_modal(event, contextid, blockid, courseid);\n        }\n    });\n};\n\nconst create_modal = (event, contextid, blockid, courseid) => {\n    const formdata = {\n        chapterid: event.target.dataset.cid,\n        blockid: blockid,\n        courseid: courseid,\n        name: event.target.dataset.cname,\n        has_lock: event.target.dataset.haslock,\n        unlocking_date: event.target.dataset.unlock,\n    };\n\n    // Set up a SAVE_CANCEL modal.\n    ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: 'Add Chapter',\n        body: get_form(formdata, contextid),\n    })\n        // Set up the listeners\n        .then((modal) => {\n            const root = modal.getRoot();\n            const form = root.find('form');\n\n            root.on(ModalEvents.save, (event) => submitForm(event, form));\n            form.on('submit', (event) =>\n                submitFormAjax(event, modal, form, contextid)\n            );\n            modal.show();\n        })\n        // Close modal\n        .then((modal) => {\n            modal.close();\n        });\n};\n\nconst get_form = (formdata, contextid) => {\n    if (typeof formdata === 'undefined') {\n        formdata = {};\n    }\n    var params = { jsonformdata: JSON.stringify(formdata) };\n    return Fragment.loadFragment(\n        'block_mission_map',\n        'chapter_form',\n        contextid,\n        params\n    );\n};\n\nconst submitForm = (event, form) => {\n    event.preventDefault();\n    form.submit();\n};\n\nconst submitFormAjax = (event, modal, form, contextid) => {\n    event.preventDefault();\n\n    var changeEvent = document.createEvent('HTMLEvents');\n    changeEvent.initEvent('change', true, true);\n\n    form.find(':input').each((element) => {\n        element.dispatchEvent(changeEvent);\n    });\n\n    let formData = form.serialize();\n    Ajax.call([\n        {\n            methodname: 'block_mission_map_create_chapter',\n            args: {\n                contextid: contextid,\n                jsonformdata: JSON.stringify(formData),\n            },\n            done: (data) => handleFormSubmissionResponse(data, modal),\n            fail: (data) => handleFormSubmissionFailure(data),\n        },\n    ]);\n};\n\nconst handleFormSubmissionFailure = (data) => {\n    Notification.alert('Warning', JSON.parse(data), 'Continue');\n};\n\n/**\n *   chapter {\n *       id: 0,\n *       name: 'ChapterName',\n *       timecreated: 0000000000,\n *       timemodified: 0000000000\n *   }\n **/\nconst handleFormSubmissionResponse = (data, modal) => {\n    const map = document.getElementById('mission_map');\n    let chapter = JSON.parse(data.data);\n\n    if (chapter.updated == true) {\n        // Ugly hack because TIME\n        location.reload();\n    } else {\n        let context = {\n            id: chapter.id,\n            name: chapter.name,\n        };\n\n        Template.render('block_mission_map/chapter', context)\n            .then((html, js) => {\n                Template.appendNodeContents(map, html, js);\n                modal.hide();\n            })\n            .fail((ex) => {\n                Notification.alert('Warning', ex, 'Continue');\n            });\n    }\n};\n"],"file":"chapters.min.js"}